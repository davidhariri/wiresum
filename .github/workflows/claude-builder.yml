name: Claude Builder
on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  build:
    # Trigger on @claude mentions in issues or issue comments
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude') &&
       !github.event.issue.pull_request)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      # Auto-create PR if Claude pushed a branch but didn't create PR
      - name: Create PR if needed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch latest branches
          git fetch origin

          # Get issue number
          ISSUE_NUMBER=${{ github.event.issue.number }}

          # Find claude branch for this issue
          BRANCH=$(git branch -r | grep "origin/claude/issue-${ISSUE_NUMBER}-" | head -1 | xargs)

          if [ -z "$BRANCH" ]; then
            echo "No claude branch found for issue #${ISSUE_NUMBER}"
            exit 0
          fi

          BRANCH_NAME=${BRANCH#origin/}
          echo "Found branch: $BRANCH_NAME"

          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #${EXISTING_PR} already exists for branch $BRANCH_NAME"
            exit 0
          fi

          # Get issue title for PR title
          ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title --jq '.title')

          # Create PR
          echo "Creating PR for branch $BRANCH_NAME"
          gh pr create \
            --head "$BRANCH_NAME" \
            --title "$ISSUE_TITLE" \
            --body "Implements #${ISSUE_NUMBER}

          Generated by Claude Code Builder." \
            --base main
