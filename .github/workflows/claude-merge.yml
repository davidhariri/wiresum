name: Claude Merge
on:
  pull_request_review:
    types: [submitted]

jobs:
  merge:
    # Only merge on approval of claude/ branches
    if: |
      github.event.review.state == 'approved' &&
      startsWith(github.event.pull_request.head.ref, 'claude/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;

            console.log(`Attempting to merge PR #${prNumber}`);

            // Get current PR state
            const { data: prData } = await github.rest.pulls.get({
              ...context.repo,
              pull_number: prNumber
            });

            console.log(`Mergeable: ${prData.mergeable}, State: ${prData.mergeable_state}`);

            // Check if PR is mergeable
            if (!prData.mergeable) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: prNumber,
                body: `@david Cannot auto-merge PR #${prNumber}: PR is not mergeable. This usually means there are merge conflicts that need manual resolution.`
              });
              core.setFailed('PR is not mergeable');
              return;
            }

            // Check mergeable state - allow 'clean' or 'unstable' (unstable = status checks pending)
            if (prData.mergeable_state !== 'clean' && prData.mergeable_state !== 'unstable') {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: prNumber,
                body: `@david Cannot auto-merge PR #${prNumber}: mergeable_state is "${prData.mergeable_state}". Please resolve any issues manually.`
              });
              core.setFailed(`Mergeable state is ${prData.mergeable_state}`);
              return;
            }

            // Perform the merge
            try {
              await github.rest.pulls.merge({
                ...context.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              console.log(`Successfully merged PR #${prNumber}`);
            } catch (error) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: prNumber,
                body: `@david Auto-merge failed for PR #${prNumber}: ${error.message}`
              });
              core.setFailed(`Merge failed: ${error.message}`);
            }
